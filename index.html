<!doctype html>

<html lang="en">
<head>
	<title>Data Visualizer</title>
	<meta name="description" content="Data visualizer">
	<meta name="author" content="David Solà">
	<meta charset="utf-8">
	<link rel="icon" href="https://avatars1.githubusercontent.com/u/7198106?s=460&u=13c9e8c4189dc06c917948305cae45d8d02d4b0f&v=4">
	
	<script src="https://d3js.org/d3.v4.min.js"></script>

	<!--<link rel="stylesheet" href="css/styles.css?v=1.0">-->

	<style>
		.default {
			fill: steelblue;
		}
		.selected1 {
			fill: red;
		}
		.selected2 {
			fill: greenyellow;
		}
		.definitive {
			fill: darkorchid;
		}
	</style>

</head>

<body onload="newChart();">
	<header>
		<button type="button" onclick="newChart()">New chart</button>
		<label for="changeSpeed">Sorting speed & size</label>
		<input type="range" min="0" max="100" id="changeSpeed" onInput="setSpeedAndSize(this.value);" style="background: white; cursor: pointer;">
		<button type="button" onclick="bubbleSort()">Sort chart!</button>
	</header>

	<div id="svg"></div>

	<footer>
		<p>Made by David Solà - 2020</p>
		<p>Version: 0.1.1</p>
	</footer>

    <script>
		var widthSvg = 1200;
		var heightSvg = 600;

		var data;
		var speed = 50;

		function setSpeedAndSize(val) {
			/*0 -> 10
			50 -> 20
			100 -> 30*/
			speed = 100 - val;
			size = val;
			if(size < 4) {
				size = 4;
			}
			newChart(size);
		}
		
		function sleep(ms) {
  			return new Promise(resolve => setTimeout(resolve, ms));
		}
		
		function changeColorColumn(index, color) {
			data[index].color = color;
			displayChart();
		}

		async function bubbleSort() {
			var swapped = true;
			let lastPos = data.length;
			while(swapped) {
				swapped = false;
				let i;
				for (i = 0; i < data.length -1; ++i) {
					let dataFirstColor = data[i].color;
					let dataSecondColor = data[i + 1].color;

					changeColorColumn(i, "selected1");
					changeColorColumn(i + 1, "selected1");

					await sleep(speed);
					if (data[i].value > data[i + 1].value) {

						swapped = true;
						let tmp = data[i];
						data[i] = data[i + 1];
						data[i + 1] = tmp

						changeColorColumn(i, "selected2");
						changeColorColumn(i + 1, "selected2");

						await sleep(speed);

						changeColorColumn(i, "default");
						changeColorColumn(i + 1, "default");

						await sleep(speed);
					} else {
						changeColorColumn(i, dataFirstColor);
						changeColorColumn(i + 1, dataSecondColor);
					}
				}
				//TODO: PENSAR EN EL LILA PEL DEFINITIU
				//lastPost
				changeColorColumn(--lastPos, "definitive");
				await sleep(speed);
			}
			while(lastPos) {
				changeColorColumn(--lastPos, "definitive");
				await sleep(speed);
			}

		}

		function newChart(length = 50) {
			data = Array.from({ length: length }, () => Math.floor(Math.random() * 40));
			data = data.map(elem => ({
				value: elem,
				color: "default"
			}));

			displayChart();
		}

		function displayChart() {

			d3.select("svg").remove(); 
			var svg = d3.select("#svg").append("svg").attr("width", widthSvg).attr("height", heightSvg);


			var svg = d3.select("svg"),
				margin = 200,
				width = svg.attr("width") - margin,
				height = svg.attr("height") - margin;

			svg.append("text")
				.attr("transform", "translate(100,0)")
				.attr("x", 300)
				.attr("y", 50)
				.attr("font-size", "24px")
				.text("Data Visualizer");

			var xScale = d3.scaleBand().range([0, width]).padding(0.2),
				yScale = d3.scaleLinear().range([height, 0]);

			xScale.domain(data.map(function(d, i) { return (i+1); }));
			yScale.domain([0, d3.max(data, function(d) { return d.value; })]);

			var g = svg.append("g")
				.attr("transform", "translate(" + 100 + "," + 100 + ")");

			g.append("g")
				.attr("transform", "translate(0," + height + ")")
				.call(d3.axisBottom(xScale));

			g.append("g")
				.call(d3.axisLeft(yScale).tickFormat(function(d) {
					return d;
				}).ticks(10))
				.append("text")
				.attr("y", 6)
				.attr("dy", "0.71em")
				.attr("text-anchor", "end")
				.text("value");

			g.selectAll(".bar")
				.data(data)
				.enter().append("rect")
				.attr("class", function(d) { return d.color; })
				.attr("x", function(d, i) { return xScale(i+1); })
				.attr("y", function(d) { return yScale(d.value); })
				.attr("width", xScale.bandwidth())
				.attr("height", function(d) { return height - yScale(d.value); });

		}

    </script>
</body>
</html>